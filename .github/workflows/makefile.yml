name: Nabula Kernel Build (veux-qgki)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Increased timeout for QGKI builds

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0  # Required for some kernel builds

    - name: Set up build environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          bbuild-essential 
    - name: Set up Clang toolchain
      run: |
        mkdir -p toolchains
        cd toolchains
        git clone --depth=1 --branch llvmorg-17.0.6 https://github.com/llvm/llvm-project clang-17
        git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 gcc
        export PATH=$(pwd)/clang-17/bin:$(pwd)/gcc/bin:$PATH
        export ARCH=arm64
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export CROSS_COMPILE=aarch64-linux-android-
        export LLVM=1
        export LLVM_IAS=1
        cd ..

    - name: Prepare build directory
      run: |
        mkdir -p out
        cp vendor/veux-qgki_defconfig out/.config

    - name: Build kernel with Clang
      run: |
        make O=out menuconfig  # Optional: Uncomment if you need to review config
        make O=out olddefconfig
        make O=out CC=clang -j$(($(nproc) + 1)) 2>&1 | tee build.log
        [ -f out/arch/arm64/boot/Image.gz-dtb ] || (echo "Build failed - no Image.gz-dtb!" && exit 1)

    - name: Package artifacts
      run: |
        mkdir -p artifacts
        cp out/arch/arm64/boot/{Image.gz-dtb,dtbo.img} artifacts/
        cp out/.config artifacts/
        cp build.log artifacts/
        tar -czvf kernel_artifacts.tar.gz artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: veux-qgki-kernel
        path: kernel_artifacts.tar.gz
