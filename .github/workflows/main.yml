name: Android Kernel Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential zip curl zlib1g-dev \
          gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
          x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
          libxml2-utils xsltproc unzip fontconfig python3 bc rsync
        
    - name: Set up toolchain
      run: |
        mkdir -p toolchains
        cd toolchains
        git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9
        export PATH=$(pwd)/aarch64-linux-android-4.9/bin:$PATH
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        cd ..
        
    - name: Build kernel
      run: |
        make clean
        make defconfig
        make -j$(nproc)
        
    - name: Archive build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: kernel-build
        path: |
          arch/arm64/boot/Image.gz-dtb
          .config
