name: Android Kernel Build - Lal Singh

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v3

    - name: Setup Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison flex libssl-dev make libc6-dev libncurses5-dev gcc clang python3 zip git ccache curl wget unzip

    - name: Download Clang Toolchain
      run: |
        mkdir clang
        wget https://github.com/ClangBuiltLinux/tc-build/releases/download/20240506/clang-r487747b.tar.xz
        tar -xf clang-r487747b.tar.xz -C clang --strip-components=1

    - name: Set up environment
      run: |
        export PATH=$(pwd)/clang/bin:$PATH
        export KERNEL_DIR=$(pwd)
        export ARCH=arm64
        export SUBARCH=arm64
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export CROSS_COMPILE=aarch64-linux-gnu-

    - name: Build Kernel
      run: |
        export PATH=$(pwd)/clang/bin:$PATH
        make O=out ARCH=arm64 <your_defconfig>
        make -j$(nproc) O=out ARCH=arm64 \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CLANG_TRIPLE=aarch64-linux-gnu-

    - name: Upload zImage/boot.img
      uses: actions/upload-artifact@v3
      with:
        name: Kernel Image
        path: out/arch/arm64/boot/Image.gz-dtb
