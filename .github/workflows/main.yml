name: ARM64 Kernel Build (veux-qgki)

on:
  push:
    branches: [ main ]  # Change if your default branch is different
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          make \
          gcc-aarch64-linux-gnu \
          gcc-cross-aarch64-linux-gnu

    - name: Set up build environment
      run: |
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-

    - name: Configure kernel
      run: |
        make vendor/veux-qgki_defconfig

    - name: Build kernel
      run: |
        make -j$(nproc) Image.gz dtbs

    - name: Package artifacts
      if: success()
      run: |
        mkdir -p artifacts
        # ARM64 specific artifacts
        [ -f arch/arm64/boot/Image.gz ] && cp arch/arm64/boot/Image.gz artifacts/
        [ -f arch/arm64/boot/dts/vendor/*.dtb ] && cp arch/arm64/boot/dts/vendor/*.dtb artifacts/
        [ -f System.map ] && cp System.map artifacts/
        [ -f .config ] && cp .config artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: arm64-kernel-build
        path: artifacts/
        retention-days: 5
